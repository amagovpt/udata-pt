##
# uWSGI configuration for udata frontend
# Este ficheiro é para a sua aplicação web frontend.
# O seu objetivo é servir as páginas web e as requisições API.
# Para que a aplicação possa atender a múltiplos utilizadores ao mesmo tempo,
# é necessário ter vários processos em execução.
#
# OPTIMIZADO: 2025-12-12 - Correcções para eliminar erros 502 Bad Gateway
##

[uwsgi]
; ============================================================================
; CONFIGURAÇÃO MASTER E PROCESSOS
; ============================================================================
; Ativa o modo mestre para gerenciar os workers.
master = true
; Define o número de processos de worker que irão atender às requisições.
processes = 4
; Define o número de threads por processo, para lidar com requisições concorrentes.
threads = 2
; Define o tamanho da pilha de threads.
thread-stacksize = 1024

; ============================================================================
; CORRECÇÃO 502 #1: LAZY-APPS
; Cada worker carrega a aplicação independentemente.
; Isto evita que todos os workers fiquem indisponíveis durante o reload.
; ============================================================================
lazy-apps = true

; ============================================================================
; CORRECÇÃO 502 #2: THUNDER-LOCK
; Serializa as chamadas accept() para evitar o "thundering herd problem".
; Quando uma conexão chega, apenas um worker é acordado em vez de todos.
; ============================================================================
thunder-lock = true

; ============================================================================
; CORRECÇÃO 502 #3: FILA DE CONEXÕES
; Aumenta o tamanho da fila de conexões pendentes.
; Evita que conexões sejam recusadas durante picos de tráfego.
; ============================================================================
listen = 1024

; ============================================================================
; CONFIGURAÇÃO DE PYTHON / AMBIENTE
; ============================================================================
; Especifica o módulo Python a ser carregado (o ponto de entrada da sua aplicação).
module = udata.wsgi
; O objeto dentro do módulo que representa a aplicação.
callable = app
; Define a variável de ambiente para o ficheiro de configuração do uData.
env = UDATA_SETTINGS=/udata/udata.cfg

; ============================================================================
; MANUSEIO DE FICHEIROS ESTÁTICOS
; ============================================================================
; Verifica se os ficheiros estáticos existem antes de servi-los.
check-static = /udata/public
; Mapeia URLs para diretórios de ficheiros estáticos (e.g., /s/style.css -> /udata/fs/style.css).
static-map = /s=/udata/fs

; ============================================================================
; THREADS PARA TAREFAS OFFLOAD
; ============================================================================
; Define o número de threads para descarregar tarefas para processamento em segundo plano.
offload-threads = 4

; ============================================================================
; CONFIGURAÇÃO DE SOQUETE
; ============================================================================
; Socket UNIX para comunicação com o Nginx (ambos no mesmo container)
socket = /var/run/uwsgi/udata.sock
; Define as permissões do socket para que o Nginx possa aceder
chmod-socket = 666
; O endereço e a porta para aceder às estatísticas do uWSGI.
stats = 0.0.0.0:7001

; ============================================================================
; CORRECÇÃO 502 #4: KEEPALIVE
; Mantém conexões activas para reduzir overhead de novas conexões.
; ============================================================================
so-keepalive = true

; ============================================================================
; TAMANHO DO BUFFER
; ============================================================================
; Define o tamanho do buffer para os cabeçalhos das requisições.
buffer-size = 32768

; ============================================================================
; THREADS E CONCORRÊNCIA
; ============================================================================
; Habilita o suporte a threads em workers para certas bibliotecas (necessário para Sentry).
enable-threads = true

; ============================================================================
; GESTÃO E RECICLAGEM DE WORKERS - OPTIMIZADO
; ============================================================================
; CORRECÇÃO 502 #5: Aumentado max-requests para reduzir frequência de reciclagem
; Recicla workers após 50,000 requisições (era 10,000).
max-requests = 50000
; Adiciona variabilidade (0-2000) ao tempo de vida para evitar reinícios simultâneos.
max-requests-delta = 2000

; CORRECÇÃO 502 #6: Aumentados limites de memória
; Recarrega o worker se a memória virtual exceder 1536 MB (era 1024).
reload-on-as = 1536
; Recarrega o worker se a memória física (RSS) exceder 768 MB (era 512).
reload-on-rss = 768
; Limita o total de memória virtual a 2 GB por worker.
limit-as = 2048

; Garante que os workers órfãos são terminados.
no-orphans = true
; Limpa ficheiros de soquete e PID quando o uWSGI é encerrado.
vacuum = true
; Força o uWSGI a sair em caso de sinal de término, em vez de recarregar.
die-on-term = true

; CORRECÇÃO 502 #7: Período de graça para graceful reload
; Período de espera para workers encerrarem antes de serem forçados a sair.
reload-mercy = 60
; Tempo de espera adicional após SIGTERM antes de SIGKILL
worker-reload-mercy = 60

; ============================================================================
; CONFIGURAÇÕES HARAKIRI (TRATAMENTO DE TEMPO LIMITE)
; ============================================================================
; Encerra workers que demoram mais de 60 segundos a responder a uma requisição.
harakiri = 60
; Regista informação detalhada quando harakiri é activado.
harakiri-verbose = true
; Define um tempo limite de 120 segundos para todas as rotas (exceto as que têm a sua própria rota).
route-run = harakiri:120
; Define um tempo limite de 600 segundos especificamente para requisições de ficheiros .csv.
route = \.csv$ harakiri:600

; ============================================================================
; MODO DE INTERPRETADOR
; ============================================================================
; Garante que todos os workers usam um único interpretador Python.
single-interpreter = true

; ============================================================================
; CONFIGURAÇÃO DE LOG
; ============================================================================
; Desativa o log de requisições individuais para evitar logs excessivos.
disable-logging = true
; Define o nível de detalhe dos logs.
log-level = warning
; Permite que o mestre do uWSGI escreva logs.
log-master = true
; Redireciona logs específicos para este ficheiro.
logto = /logs/app.logs
; Regista erros HTTP 5xx no log.
log-5xx = true

; ============================================================================
; MONITORIZAÇÃO DE WORKERS (para debug se necessário)
; ============================================================================
; Descomente para ver quando workers são reciclados:
; log-reopen = true
; log-slow = 3000
